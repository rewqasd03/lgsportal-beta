<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Debug - Eksik Deneme Kaydƒ±</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        .content {
            padding: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .section h3 {
            margin-top: 0;
            color: #2d3748;
        }
        .debug-output {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.5;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #667eea;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .success { color: #48bb78; }
        .error { color: #f56565; }
        .warning { color: #ed8936; }
        .info { color: #4299e1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Firebase Debug</h1>
            <p>Eksik Deneme Kaydƒ± Sorunu Analizi</p>
        </div>
        
        <div class="content">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Firebase verileri analiz ediliyor...</p>
            </div>
            
            <div id="debug-output" class="debug-output" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBYfBhkLIfjqpnL9MxBhxW6iJeC0VAEDLk",
            authDomain: "kopruler-basari-portali.firebaseapp.com",
            projectId: "kopruler-basari-portali",
            storageBucket: "kopruler-basari-portali.firebasestorage.app",
            messagingSenderId: "318334276429",
            appId: "1:318334276429:web:7caa5e5b9dccb564d71d04",
            measurementId: "G-EF6P77SMFP"
        };

        // Firebase'i initialize et
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function log(message, className = '') {
            const output = document.getElementById('debug-output');
            const span = document.createElement('span');
            if (className) span.className = className;
            span.textContent = message;
            output.appendChild(span);
            output.appendChild(document.createElement('br'));
            console.log(message);
        }

        function showResults() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('debug-output').style.display = 'block';
        }

        async function debugExamDataInconsistency() {
            try {
                log('üîç Firebase Debug: Eksik Deneme Kaydƒ± Sorunu Analizi', 'info');
                log('='.repeat(80), 'info');
                
                // 1. Exams tablosundaki t√ºm verileri al
                log('\nüìä 1. Exams Tablosu Analizi:', 'info');
                const examsQuery = await db.collection('exams').get();
                const examsData = examsQuery.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                log(`   Toplam Exam Kaydƒ±: ${examsData.length}`, 'success');
                log('   Exam ID\'leri:', 'info');
                examsData.forEach((exam, index) => {
                    const title = exam.title || 'Ba≈ülƒ±k yok';
                    const date = exam.date || 'Tarih yok';
                    log(`   ${index + 1}. ${exam.id} - ${title} (${date})`);
                });
                
                // 2. Results tablosundaki t√ºm verileri al
                log('\nüìä 2. Results Tablosu Analizi:', 'info');
                const resultsQuery = await db.collection('results').get();
                const resultsData = resultsQuery.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                log(`   Toplam Result Kaydƒ±: ${resultsData.length}`, 'success');
                
                // 3. Hangi examId'lerin results tablosunda bulunduƒüunu bul
                const resultExamIds = [...new Set(resultsData.map(r => r.examId))];
                log('\nüìä 3. Results Tablosundaki ExamId\'ler:', 'info');
                log(`   Toplam Benzersiz ExamId: ${resultExamIds.length}`, 'success');
                resultExamIds.forEach((examId, index) => {
                    const examResults = resultsData.filter(r => r.examId === examId);
                    log(`   ${index + 1}. ${examId} (${examResults.length} sonu√ß)`);
                });
                
                // 4. Hangi examId'lerin eksik olduƒüunu bul
                const availableExamIds = examsData.map(e => e.id);
                const missingExamIds = resultExamIds.filter(id => !availableExamIds.includes(id));
                
                log('\n‚ö†Ô∏è 4. EKSƒ∞K EXAM KAYITLARI:', 'warning');
                if (missingExamIds.length === 0) {
                    log('   ‚úÖ T√ºm exam kayƒ±tlarƒ± mevcut - Sorun ba≈üka yerde olabilir', 'success');
                } else {
                    log(`   ‚ùå ${missingExamIds.length} adet eksik exam kaydƒ± bulundu:`, 'error');
                    missingExamIds.forEach((missingId, index) => {
                        const relatedResults = resultsData.filter(r => r.examId === missingId);
                        const studentIds = relatedResults.slice(0, 5).map(r => r.studentId).join(', ');
                        log(`   ${index + 1}. ${missingId}`, 'error');
                        log(`      - Results tablosunda ${relatedResults.length} kayƒ±t bulunuyor`, 'warning');
                        log(`      - ƒ∞lk birka√ß studentId: ${studentIds}`, 'warning');
                    });
                }
                
                // 5. Sƒ±nƒ±f bazƒ±nda analiz
                log('\nüìä 5. Sƒ±nƒ±f Bazƒ±nda Analiz:', 'info');
                const studentsQuery = await db.collection('students').get();
                const studentsData = studentsQuery.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                log(`   Toplam √ñƒürenci: ${studentsData.length}`, 'success');
                
                // 8-A sƒ±nƒ±fƒ±nƒ± √∂rnek alalƒ±m
                const sinif8A = studentsData.filter(s => s.class === '8-A');
                log(`   8-A Sƒ±nƒ±fƒ± √ñƒürenci Sayƒ±sƒ±: ${sinif8A.length}`, 'success');
                
                if (sinif8A.length > 0) {
                    const sinif8AResults = resultsData.filter(r => sinif8A.some(s => s.id === r.studentId));
                    const sinif8AExamIds = [...new Set(sinif8AResults.map(r => r.examId))];
                    
                    log('\n   8-A Sƒ±nƒ±fƒ± Exam Durumu:', 'info');
                    sinif8AExamIds.forEach(examId => {
                        const examExists = availableExamIds.includes(examId);
                        const exam = examsData.find(e => e.id === examId);
                        const hasResults = sinif8AResults.filter(r => r.examId === examId);
                        
                        const status = examExists ? '‚úÖ Mevcut' : '‚ùå Eksik';
                        log(`   - ${examId}: ${status} (${hasResults.length} sonu√ß)`, examExists ? 'success' : 'error');
                        if (exam) {
                            log(`     Ba≈ülƒ±k: ${exam.title || 'Ba≈ülƒ±k yok'}`);
                        }
                    });
                }
                
                // 6. Eksik kayƒ±tlar i√ßin detaylƒ± analiz
                if (missingExamIds.length > 0) {
                    log('\nüîç 6. Eksik Kayƒ±tlar ƒ∞√ßin Detaylƒ± Analiz:', 'info');
                    
                    for (const missingId of missingExamIds) {
                        log(`\n   ExamId: ${missingId}`, 'warning');
                        const relatedResults = resultsData.filter(r => r.examId === missingId);
                        
                        log(`   - Toplam Sonu√ß: ${relatedResults.length}`, 'info');
                        const studentIds = relatedResults.slice(0, 10).map(r => r.studentId).join(', ');
                        log(`   - √ñƒürenci ID'leri: ${studentIds}`, 'info');
                        
                        // ƒ∞lk sonucun detaylarƒ±nƒ± g√∂ster
                        if (relatedResults.length > 0) {
                            const firstResult = relatedResults[0];
                            log(`   - ƒ∞lk Sonu√ß Detayƒ±:`, 'info');
                            log(`     * StudentId: ${firstResult.studentId}`, 'info');
                            log(`     * ExamId: ${firstResult.examId}`, 'info');
                            log(`     * Nets: ${JSON.stringify(firstResult.nets)}`, 'info');
                            log(`     * Scores: ${JSON.stringify(firstResult.scores)}`, 'info');
                            log(`     * CreatedAt: ${firstResult.createdAt}`, 'info');
                        }
                    }
                }
                
                log('\n' + '='.repeat(80), 'info');
                log('üéØ SONU√á:', 'info');
                if (missingExamIds.length > 0) {
                    log(`‚ùå ${missingExamIds.length} adet exam kaydƒ± eksik. Bu "Eksik Deneme Kaydƒ±" sorununun nedeni.`, 'error');
                    log('üîß √á√ñZ√úM √ñNERƒ∞LERƒ∞:', 'info');
                    log('1. Bu examId\'ler i√ßin eksik exam kayƒ±tlarƒ± olu≈ütur', 'info');
                    log('2. Ya da results tablosundaki bu kayƒ±tlarƒ± sil', 'info');
                    log('3. Ya da examId\'leri mevcut exam kayƒ±tlarƒ±yla e≈üle≈ütir', 'info');
                    
                    // √á√∂z√ºm scriptini hazƒ±rla
                    log('\nüõ†Ô∏è OTOMATƒ∞K √á√ñZ√úM SCRIPTI:', 'info');
                    log('A≈üaƒüƒ±daki examId\'ler i√ßin eksik kayƒ±tlar olu≈üturulacak:', 'warning');
                    missingExamIds.forEach(id => {
                        log(`   - ${id}`, 'warning');
                    });
                    
                } else {
                    log('‚úÖ Exams tablosunda sorun bulunamadƒ±. Sorun ba≈üka yerde olabilir.', 'success');
                }
                
                showResults();
                
            } catch (error) {
                log('‚ùå Firebase baƒülantƒ± hatasƒ±: ' + error.message, 'error');
                console.error('Firebase error:', error);
                showResults();
            }
        }

        // Sayfa y√ºklendiƒüinde debug'u √ßalƒ±≈ütƒ±r
        window.addEventListener('load', debugExamDataInconsistency);
    </script>
</body>
</html>