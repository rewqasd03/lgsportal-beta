<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Debug - Eksik Deneme KaydÄ±</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px;">
        <h1>ğŸ” Firebase Debug: Eksik Deneme KaydÄ± Analizi</h1>
        <div id="output" style="background: #f5f5f5; padding: 20px; border-radius: 8px; white-space: pre-wrap; font-family: monospace;"></div>
    </div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBYfBhkLIfjqpnL9MxBhxW6iJeC0VAEDLk",
            authDomain: "kopruler-basari-portali.firebaseapp.com",
            projectId: "kopruler-basari-portali",
            storageBucket: "kopruler-basari-portali.firebasestorage.app",
            messagingSenderId: "318334276429",
            appId: "1:318334276429:web:7caa5e5b9dccb564d71d04",
            measurementId: "G-EF6P77SMFP"
        };

        // Firebase'i initialize et
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function log(message) {
            document.getElementById('output').textContent += message + '\n';
            console.log(message);
        }

        async function debugExamDataInconsistency() {
            log('ğŸ” Firebase Debug: Eksik Deneme KaydÄ± Sorunu Analizi');
            log('='.repeat(60));
            
            try {
                // 1. Exams tablosundaki tÃ¼m verileri al
                log('\nğŸ“Š 1. Exams Tablosu Analizi:');
                const examsQuery = await db.collection('exams').get();
                const examsData = examsQuery.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                log(`   Toplam Exam KaydÄ±: ${examsData.length}`);
                log('   Exam ID\'leri:');
                examsData.forEach((exam, index) => {
                    log(`   ${index + 1}. ${exam.id} - ${exam.title || 'BaÅŸlÄ±k yok'} (${exam.date || 'Tarih yok'})`);
                });
                
                // 2. Results tablosundaki tÃ¼m verileri al
                log('\nğŸ“Š 2. Results Tablosu Analizi:');
                const resultsQuery = await db.collection('results').get();
                const resultsData = resultsQuery.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                log(`   Toplam Result KaydÄ±: ${resultsData.length}`);
                
                // 3. Hangi examId'lerin results tablosunda bulunduÄŸunu bul
                const resultExamIds = [...new Set(resultsData.map(r => r.examId))];
                log('\nğŸ“Š 3. Results Tablosundaki ExamId\'ler:');
                log(`   Toplam Benzersiz ExamId: ${resultExamIds.length}`);
                resultExamIds.forEach((examId, index) => {
                    const examResults = resultsData.filter(r => r.examId === examId);
                    log(`   ${index + 1}. ${examId} (${examResults.length} sonuÃ§)`);
                });
                
                // 4. Hangi examId'lerin eksik olduÄŸunu bul
                const availableExamIds = examsData.map(e => e.id);
                const missingExamIds = resultExamIds.filter(id => !availableExamIds.includes(id));
                
                log('\nâš ï¸ 4. EKSÄ°K EXAM KAYITLARI:');
                if (missingExamIds.length === 0) {
                    log('   âœ… TÃ¼m exam kayÄ±tlarÄ± mevcut - Sorun baÅŸka yerde olabilir');
                } else {
                    log(`   âŒ ${missingExamIds.length} adet eksik exam kaydÄ± bulundu:`);
                    missingExamIds.forEach((missingId, index) => {
                        const relatedResults = resultsData.filter(r => r.examId === missingId);
                        log(`   ${index + 1}. ${missingId}`);
                        log(`      - Results tablosunda ${relatedResults.length} kayÄ±t bulunuyor`);
                        log(`      - Ä°lk birkaÃ§ studentId: ${relatedResults.slice(0, 5).map(r => r.studentId).join(', ')}`);
                    });
                }
                
                // 5. SÄ±nÄ±f bazÄ±nda analiz
                log('\nğŸ“Š 5. SÄ±nÄ±f BazÄ±nda Analiz:');
                const studentsQuery = await db.collection('students').get();
                const studentsData = studentsQuery.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                log(`   Toplam Ã–ÄŸrenci: ${studentsData.length}`);
                
                // 8-A sÄ±nÄ±fÄ±nÄ± Ã¶rnek alalÄ±m
                const sinif8A = studentsData.filter(s => s.class === '8-A');
                log(`   8-A SÄ±nÄ±fÄ± Ã–ÄŸrenci SayÄ±sÄ±: ${sinif8A.length}`);
                
                if (sinif8A.length > 0) {
                    const sinif8AResults = resultsData.filter(r => sinif8A.some(s => s.id === r.studentId));
                    const sinif8AExamIds = [...new Set(sinif8AResults.map(r => r.examId))];
                    
                    log('\n   8-A SÄ±nÄ±fÄ± Exam Durumu:');
                    sinif8AExamIds.forEach(examId => {
                        const examExists = availableExamIds.includes(examId);
                        const exam = examsData.find(e => e.id === examId);
                        const hasResults = sinif8AResults.filter(r => r.examId === examId);
                        
                        log(`   - ${examId}: ${examExists ? 'âœ… Mevcut' : 'âŒ Eksik'} (${hasResults.length} sonuÃ§)`);
                        if (exam) {
                            log(`     BaÅŸlÄ±k: ${exam.title || 'BaÅŸlÄ±k yok'}`);
                        }
                    });
                }
                
                // 6. Eksik kayÄ±tlar iÃ§in detaylÄ± analiz
                if (missingExamIds.length > 0) {
                    log('\nğŸ” 6. Eksik KayÄ±tlar Ä°Ã§in DetaylÄ± Analiz:');
                    
                    for (const missingId of missingExamIds) {
                        log(`\n   ExamId: ${missingId}`);
                        const relatedResults = resultsData.filter(r => r.examId === missingId);
                        
                        log(`   - Toplam SonuÃ§: ${relatedResults.length}`);
                        log(`   - Ã–ÄŸrenci ID'leri: ${relatedResults.slice(0, 10).map(r => r.studentId).join(', ')}`);
                        
                        // Ä°lk sonucun detaylarÄ±nÄ± gÃ¶ster
                        if (relatedResults.length > 0) {
                            const firstResult = relatedResults[0];
                            log(`   - Ä°lk SonuÃ§ DetayÄ±:`);
                            log(`     * StudentId: ${firstResult.studentId}`);
                            log(`     * ExamId: ${firstResult.examId}`);
                            log(`     * Nets: ${JSON.stringify(firstResult.nets)}`);
                            log(`     * Scores: ${JSON.stringify(firstResult.scores)}`);
                            log(`     * CreatedAt: ${firstResult.createdAt}`);
                        }
                    }
                }
                
                log('\n' + '='.repeat(60));
                log('ğŸ¯ SONUÃ‡:');
                if (missingExamIds.length > 0) {
                    log(`âŒ ${missingExamIds.length} adet exam kaydÄ± eksik. Bu "Eksik Deneme KaydÄ±" sorununun nedeni.`);
                    log('ğŸ”§ Ã‡Ã–ZÃœM Ã–NERÄ°LERÄ°:');
                    log('1. Bu examId\'ler iÃ§in eksik exam kayÄ±tlarÄ± oluÅŸtur');
                    log('2. Ya da results tablosundaki bu kayÄ±tlarÄ± sil');
                    log('3. Ya da examId\'leri mevcut exam kayÄ±tlarÄ±yla eÅŸleÅŸtir');
                } else {
                    log('âœ… Exams tablosunda sorun bulunamadÄ±. Sorun baÅŸka yerde olabilir.');
                }
                
            } catch (error) {
                log('âŒ Firebase baÄŸlantÄ± hatasÄ±: ' + error.message);
                console.error('Firebase error:', error);
            }
        }

        // Sayfa yÃ¼klendiÄŸinde debug'u Ã§alÄ±ÅŸtÄ±r
        window.addEventListener('load', debugExamDataInconsistency);
    </script>
</body>
</html>